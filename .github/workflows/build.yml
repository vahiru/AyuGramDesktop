name: Cross-Compile Windows ARM64

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: true # 确保下载所有依赖源码
        
    - name: Setup Vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        # 这一步将自动为 arm64-windows 交叉编译 Qt 和 Boost 等依赖
        vcpkgArguments: qtbase openssl-static boost-regex zlib
        vcpkgTriplet: arm64-windows
        # 缓存配置：加速后续编译 (首次运行会忽略缓存)
        vcpkgCache: true

    - name: Configure CMake
      run: |
        cmake -G "Ninja" -B build -S . `
          -DCMAKE_BUILD_TYPE=Release `
          -DVCPKG_TARGET_TRIPLET=arm64-windows `
          -DTDESKTOP_API_ID=23316314 `
          -DTDESKTOP_API_HASH=0fc6b9958356f1e37bbbe3bef200f4d6 `
          -DDESKTOP_APP_DISABLE_SPELLCHECK=ON
      env:
        VCPKG_ROOT: ${{ env.VCPKG_INSTALLATION_ROOT }}

    - name: Build Project
      # 使用 4 个核心并行编译 (Ninja)
      run: cmake --build build --config Release --target all --parallel 4
      
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ayugram-windows-arm64
        # 假设最终可执行文件在 build/Release 或 build/Debug 中
        path: build/Release/*.exe
